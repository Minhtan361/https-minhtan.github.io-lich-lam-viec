<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Ứng dụng đăng ký ca làm việc cho nhân viên">
  <meta name="author" content="minhtan">
  <title>Lịch Làm by minhtan</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    /* Giữ nguyên các style từ file gốc */
    ::-webkit-scrollbar{height:8px;width:8px}::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:8px}
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }
    
    .shift-indicator {
      position: relative;
      overflow: hidden;
    }
    
    .shift-indicator::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }
    
    .shift-morning::after {
      background: linear-gradient(to bottom, #fbbf24, #f59e0b);
    }
    
    .shift-evening::after {
      background: linear-gradient(to bottom, #6366f1, #4f46e5);
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .day-cell {
      transition: all 0.2s ease;
    }
    
    .day-cell:hover {
      background-color: #f0f4ff;
    }
    
    .day-cell.selected {
      background-color: #e0e7ff;
      border-color: #818cf8;
    }
    
    .pulse-alert {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* Thêm style cho phần đăng nhập */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .login-form {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <!-- Màn hình đăng nhập -->
  <div id="loginScreen" class="login-container">
    <div class="login-form">
      <h2 class="text-2xl font-bold text-center mb-6">Đăng nhập</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
        <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
      </div>
      <button id="loginBtn" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
        Đăng nhập
      </button>
      <p class="text-center text-sm text-gray-500 mt-4">
        Liên hệ admin nếu chưa có tài khoản
      </p>
    </div>
  </div>

  <!-- Ứng dụng chính (ẩn ban đầu) -->
  <div id="appContainer" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 text-slate-800 hidden">
    <div class="max-w-6xl mx-auto p-4 sm:p-6">
      <!-- Header -->
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
        <div class="bg-white rounded-2xl p-5 shadow-lg border border-slate-100">
          <h1 class="text-2xl sm:text-3xl font-bold tracking-tight bg-clip-text text-transparent gradient-bg">
            <i class="fas fa-calendar-alt mr-2"></i>Đăng Ký Ca Làm by minhtan
          </h1>
          <div class="flex flex-wrap gap-3 mt-3">
            <div class="flex items-center text-sm">
              <div class="w-3 h-3 rounded-full bg-amber-400 mr-2"></div>
              <span class="text-slate-600">Buổi sáng: <b id="morning-capacity-text">2</b> người (T2→CN)</span>
            </div>
            <div class="flex items-center text-sm">
              <div class="w-3 h-3 rounded-full bg-indigo-500 mr-2"></div>
              <span class="text-slate-600">Buổi tối: <b id="evening-weekday-capacity-text">4</b> người (T2→T5), <b id="evening-weekend-capacity-text">5</b> người (T6→CN)</span>
            </div>
          </div>
        </div>
        
        <!-- Tuần và thông tin user -->
        <div class="bg-white rounded-2xl p-4 shadow-lg border border-slate-100">
          <div class="flex flex-col sm:flex-row items-center gap-3">
            <label class="text-sm text-slate-600 whitespace-nowrap" for="weekStart">
              <i class="far fa-calendar mr-1"></i>Tuần bắt đầu:
            </label>
            <input id="weekStart" type="date" class="px-4 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <div class="flex gap-2">
              <button id="prevWeek" class="px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm hover:bg-slate-50 transition-colors">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button id="nextWeek" class="px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm hover:bg-slate-50 transition-colors">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="mt-3 pt-3 border-t border-slate-100 flex items-center justify-between">
            <span id="userEmail" class="text-sm text-slate-600"></span>
            <button id="logoutBtn" class="text-sm text-rose-600 hover:text-rose-700">
              <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
            </button>
          </div>
        </div>
      </header>

      <!-- Thông báo -->
      <div id="toast" class="hidden mb-6 p-4 rounded-xl border-l-4 shadow-md"></div>

      <!-- Form đăng ký -->
      <section class="grid md:grid-cols-2 gap-6 mb-8">
        <form id="signupForm" class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 border border-slate-100 card-hover">
          <h2 class="font-semibold text-lg mb-4 flex items-center">
            <i class="fas fa-pen-to-square mr-2 text-indigo-500"></i>Đăng ký ca
          </h2>
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label class="text-sm text-slate-600 font-medium">Họ và tên</label>
              <div class="relative mt-1">
                <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <select id="empName" class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                  <option value="">-- Chọn nhân viên --</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-sm text-slate-600 font-medium">Buổi</label>
              <div class="relative mt-1">
                <i class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <select id="shift" class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  <option value="sang">Sáng</option>
                  <option value="toi">Tối</option>
                </select>
              </div>
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm text-slate-600 font-medium">Chọn ngày (trong tuần đang xem)</label>
              <div id="dayChoices" class="mt-2 grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-2"></div>
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm text-slate-600 font-medium">Ghi chú (tùy chọn)</label>
              <div class="relative mt-1">
                <i class="fas fa-sticky-note absolute left-3 top-3 transform -translate-y-1/2 text-slate-400"></i>
                <textarea id="note" placeholder="Ghi chú cho ca làm này..." class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-between mt-6 pt-4 border-t border-slate-100">
            <p class="text-xs text-slate-500"><i class="fas fa-info-circle mr-1"></i>Không thể đăng ký trùng ca cùng ngày.</p>
            <button class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-md transition-colors flex items-center" type="submit">
              <i class="fas fa-check-circle mr-2"></i>Đăng ký
            </button>
          </div>
        </form>

        <!-- Khối quản trị -->
        <div id="adminSection" class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 border border-slate-100 card-hover hidden">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-lg flex items-center">
              <i class="fas fa-lock mr-2 text-slate-600"></i>Quản trị
            </h2>
          </div>
          <p id="adminNote" class="mt-3 text-sm text-slate-500 bg-slate-50 p-2 rounded-lg">
            <i class="fas fa-shield-alt mr-1"></i>Chỉ admin mới xóa/chỉnh đăng ký và xuất Excel (CSV).
          </p>
          <div class="mt-4 flex items-center gap-3 pt-4 border-t border-slate-100">
            <button id="exportBtn" class="px-4 py-2.5 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40 transition-colors flex items-center">
              <i class="fas fa-file-export mr-2"></i>Xuất Excel
            </button>
            <button id="clearWeekBtn" class="px-4 py-2.5 rounded-xl bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-40 transition-colors flex items-center pulse-alert">
              <i class="fas fa-trash mr-2"></i>Xóa tuần
            </button>
          </div>
          <div id="adminControls" class="mt-4 pt-4 border-t border-slate-100">
            <h3 class="font-medium mb-3 flex items-center">
              <i class="fas fa-users-cog mr-2 text-indigo-500"></i>Quản lý nhân viên
            </h3>
            <div class="flex gap-2 mb-3">
              <input id="newEmployee" type="text" placeholder="Tên nhân viên mới" class="flex-1 px-4 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <button id="addEmployeeBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                <i class="fas fa-plus mr-1"></i>Thêm
              </button>
            </div>
            <div class="max-h-40 overflow-y-auto mb-4">
              <ul id="employeeList" class="space-y-1"></ul>
            </div>
            
            <h3 class="font-medium mb-3 flex items-center mt-4">
              <i class="fas fa-sliders-h mr-2 text-indigo-500"></i>Tùy chỉnh sức chứa
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <label class="text-sm text-slate-600">Sáng (T2-CN)</label>
                <input id="capacityMorning" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="text-sm text-slate-600">Tối (T2-T5)</label>
                <input id="capacityEveningWeekday" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="text-sm text-slate-600">Tối (T6-CN)</label>
                <input id="capacityEveningWeekend" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <button id="saveCapacityBtn" class="mt-3 w-full px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
              <i class="fas fa-save mr-1"></i>Lưu cài đặt
            </button>
          </div>
        </div>
      </section>

      <!-- Lịch tuần -->
      <section id="weekGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 mb-10"></section>

      <footer class="mt-12 text-center text-xs text-slate-500 border-t border-slate-200 pt-6">
        <div class="flex items-center justify-center gap-1 mb-1">
          <i class="fas fa-calendar-check text-indigo-500"></i>
          <span>© 2025 — Shift Signup Pro</span>
        </div>
        <p>Dữ liệu được lưu trữ trên Firebase</p>
      </footer>
    </div>
  </div>

  <script>
    // ====== Cấu hình Firebase ======
    const firebaseConfig = {
  apiKey: "AIzaSyCv8G2wLnih8XyBsL2H9yzo4ss9mQ3dIbo",
  authDomain: "lich-lam-vic.firebaseapp.com",
  projectId: "lich-lam-vic",
  storageBucket: "lich-lam-vic.firebasestorage.app",
  messagingSenderId: "715785571243",
  appId: "1:715785571243:web:c3d69593bfe22e2c9c20ee",
  measurementId: "G-2JCT2EFLH4"
};

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ====== Cấu hình ứng dụng ======
    const VN_DAYS = ['Thứ 2','Thứ 3','Thứ 4','Thứ 5','Thứ 6','Thứ 7','Chủ nhật'];

    // ====== Helpers ngày/tuần ======
    function startOfWeek(date) {
      const d = new Date(date);
      const day = (d.getDay() + 6) % 7;
      d.setDate(d.getDate() - day);
      d.setHours(0,0,0,0);
      return d;
    }

    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate()+days);
      return d;
    }

    function fmtISODate(date){
      return date.toISOString().slice(0,10);
    }

    // ====== Quản lý giao diện ======
    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('appContainer');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const adminSection = document.getElementById('adminSection');
    const weekStartInput = document.getElementById('weekStart');
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    const dayChoices = document.getElementById('dayChoices');
    const weekGrid = document.getElementById('weekGrid');
    const signupForm = document.getElementById('signupForm');
    const empNameSelect = document.getElementById('empName');
    const shiftSelect = document.getElementById('shift');
    const noteInput = document.getElementById('note');
    const exportBtn = document.getElementById('exportBtn');
    const clearWeekBtn = document.getElementById('clearWeekBtn');
    const toast = document.getElementById('toast');
    const adminControls = document.getElementById('adminControls');
    const newEmployeeInput = document.getElementById('newEmployee');
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const employeeList = document.getElementById('employeeList');
    const capacityMorningInput = document.getElementById('capacityMorning');
    const capacityEveningWeekdayInput = document.getElementById('capacityEveningWeekday');
    const capacityEveningWeekendInput = document.getElementById('capacityEveningWeekend');
    const saveCapacityBtn = document.getElementById('saveCapacityBtn');
    const morningCapacityText = document.getElementById('morning-capacity-text');
    const eveningWeekdayCapacityText = document.getElementById('evening-weekday-capacity-text');
    const eveningWeekendCapacityText = document.getElementById('evening-weekend-capacity-text');

    let currentWeekStart = startOfWeek(new Date());
    let currentUser = null;
    let isAdmin = false;
    let employees = [];
    let capacitySettings = {};
    let weekData = [];

    function showToast(msg, type='ok'){
      toast.textContent = msg;
      toast.className = '';
      toast.classList.add('p-4', 'rounded-xl', 'border-l-4', 'shadow-md', 'mb-6');
      
      if (type === 'ok') {
        toast.classList.add('bg-emerald-50', 'text-emerald-700', 'border-emerald-400');
        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i> ${msg}</div>`;
      } else {
        toast.classList.add('bg-rose-50', 'text-rose-700', 'border-rose-400');
        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> ${msg}</div>`;
      }
      
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'), 3000);
    }

    // ====== Firebase Functions ======
    async function loadEmployees() {
      try {
        const snapshot = await db.collection('employees').get();
        employees = snapshot.docs.map(doc => doc.data().name);
        renderEmployeeDropdown();
        renderEmployeeList();
      } catch (error) {
        console.error("Error loading employees:", error);
        showToast('Lỗi khi tải danh sách nhân viên', 'err');
      }
    }

    async function addEmployee(name) {
      try {
        await db.collection('employees').add({
          name: name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadEmployees();
        showToast('Đã thêm nhân viên mới', 'ok');
      } catch (error) {
        console.error("Error adding employee:", error);
        showToast('Lỗi khi thêm nhân viên', 'err');
      }
    }

    async function deleteEmployee(name) {
      try {
        const querySnapshot = await db.collection('employees')
          .where('name', '==', name)
          .get();
        
        querySnapshot.forEach(async (doc) => {
          await db.collection('employees').doc(doc.id).delete();
        });
        
        await loadEmployees();
        showToast('Đã xóa nhân viên', 'ok');
      } catch (error) {
        console.error("Error deleting employee:", error);
        showToast('Lỗi khi xóa nhân viên', 'err');
      }
    }

    async function loadCapacitySettings() {
      try {
        const doc = await db.collection('settings').doc('capacity').get();
        if (doc.exists) {
          capacitySettings = doc.data();
        } else {
          // Default values
          capacitySettings = {
            morning: 2,
            eveningWeekday: 4,
            eveningWeekend: 5
          };
          await db.collection('settings').doc('capacity').set(capacitySettings);
        }
        loadCapacityInputs();
      } catch (error) {
        console.error("Error loading capacity settings:", error);
        showToast('Lỗi khi tải cài đặt', 'err');
      }
    }

    async function saveCapacitySettings() {
      try {
        await db.collection('settings').doc('capacity').set(capacitySettings);
        loadCapacityInputs();
        showToast('Đã lưu cài đặt sức chứa', 'ok');
      } catch (error) {
        console.error("Error saving capacity settings:", error);
        showToast('Lỗi khi lưu cài đặt', 'err');
      }
    }

    async function loadWeekData() {
      try {
        const weekKey = fmtISODate(currentWeekStart);
        const snapshot = await db.collection('shifts')
          .where('week', '==', weekKey)
          .get();
        
        weekData = [];
        snapshot.forEach(doc => {
          weekData.push(doc.data());
        });
        
        renderWeekGrid();
      } catch (error) {
        console.error("Error loading week data:", error);
        showToast('Lỗi khi tải dữ liệu tuần', 'err');
      }
    }

    async function addShift(shiftData) {
      try {
        await db.collection('shifts').add({
          ...shiftData,
          week: fmtISODate(currentWeekStart),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          userId: currentUser.uid
        });
        
        await loadWeekData();
        showToast('Đăng ký thành công!', 'ok');
        noteInput.value = '';
      } catch (error) {
        console.error("Error adding shift:", error);
        showToast('Lỗi khi đăng ký ca', 'err');
      }
    }

    async function deleteShift(shiftId) {
      try {
        await db.collection('shifts').doc(shiftId).delete();
        await loadWeekData();
        showToast('Đã xóa đăng ký.', 'ok');
      } catch (error) {
        console.error("Error deleting shift:", error);
        showToast('Lỗi khi xóa đăng ký', 'err');
      }
    }

    async function clearWeek() {
      try {
        const weekKey = fmtISODate(currentWeekStart);
        const snapshot = await db.collection('shifts')
          .where('week', '==', weekKey)
          .get();
        
        const batch = db.batch();
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        await loadWeekData();
        showToast('Đã xóa toàn bộ đăng ký tuần.', 'ok');
      } catch (error) {
        console.error("Error clearing week:", error);
        showToast('Lỗi khi xóa dữ liệu tuần', 'err');
      }
    }

    // ====== Giao diện ======
    function renderDayChoices(){
      dayChoices.innerHTML = '';
      for (let i=0;i<7;i++){
        const d = addDays(currentWeekStart,i);
        const btn = document.createElement('button');
        btn.type='button';
        btn.dataset.dayIndex=i;
        btn.className='day-cell px-3 py-2.5 rounded-xl border border-slate-300 bg-white hover:bg-indigo-50 text-sm transition-colors';
        btn.innerHTML = `<div class="font-medium">${VN_DAYS[i].substring(0, 3)}</div><div class="text-xs text-slate-500">${d.getDate()}/${d.getMonth()+1}</div>`;
        btn.addEventListener('click',()=>{
          [...dayChoices.children].forEach(c=>c.classList.remove('selected'));
          btn.classList.add('selected');
          dayChoices.dataset.selected = i;
        });
        dayChoices.appendChild(btn);
      }
      dayChoices.children[0]?.click();
    }

    function capacityFor(dayIndex, shift) {
      if (shift === 'sang') {
        return capacitySettings.morning || 2;
      }
      
      return dayIndex <= 3 
        ? (capacitySettings.eveningWeekday || 4) 
        : (capacitySettings.eveningWeekend || 5);
    }

    function renderWeekGrid(){
      weekGrid.innerHTML = '';
      for (let i=0;i<7;i++){
        const dayDate = addDays(currentWeekStart,i);
        const isToday = fmtISODate(dayDate) === fmtISODate(new Date());
        
        const col = document.createElement('div');
        col.className=`bg-white rounded-2xl shadow-lg border ${isToday ? 'border-indigo-300 ring-1 ring-indigo-200' : 'border-slate-100'} flex flex-col card-hover animate-fade-in`;

        const header = document.createElement('div');
        header.className=`px-4 py-3 border-b border-slate-100 flex items-center justify-between ${isToday ? 'bg-indigo-50' : ''}`;
        header.innerHTML = `
          <div>
            <div class="text-sm text-slate-500">${VN_DAYS[i]}</div>
            <div class="font-semibold ${isToday ? 'text-indigo-600' : ''}">${dayDate.getDate()}/${dayDate.getMonth()+1}</div>
          </div>
          ${isToday ? '<span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded-full">Hôm nay</span>' : ''}
        `;
        col.appendChild(header);

        ['sang','toi'].forEach(shift=>{
          const cap = capacityFor(i, shift);
          const items = weekData.filter(e => e.dayIndex === i && e.shift === shift);
          const remain = cap - items.length;
          const isFull = remain <= 0;

          const wrap = document.createElement('div');
          wrap.className=`p-4 border-b border-slate-100 last:border-b-0 shift-indicator ${shift === 'sang' ? 'shift-morning' : 'shift-evening'}`;

          const title = document.createElement('div');
          title.className='flex items-center justify-between mb-3';
          title.innerHTML = `
            <div class="font-medium flex items-center">
              ${shift==='sang' ? '<i class="fas fa-sun text-amber-500 mr-2"></i>' : '<i class="fas fa-moon text-indigo-500 mr-2"></i>'}
              ${shift==='sang'?'Buổi sáng':'Buổi tối'} 
              <span class="text-xs text-slate-500 ml-1">(Tối đa ${cap})</span>
            </div>
            <div class="text-xs font-medium ${isFull ? 'text-rose-600 bg-rose-50 px-2 py-1 rounded-full' : 'text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full'}">
              ${isFull ? 'Đã đủ' : `Còn ${remain}`}
            </div>
          `;
          wrap.appendChild(title);

          const list = document.createElement('div');
          list.className='flex flex-col gap-2';

          if (items.length===0){
            const empty = document.createElement('div');
            empty.className='text-sm text-slate-400 italic text-center py-2';
            empty.innerHTML = '<i class="far fa-frown mr-1"></i> Chưa có ai đăng ký';
            list.appendChild(empty);
          } else {
            items.forEach((e)=>{
              const row = document.createElement('div');
              row.className='group flex items-center justify-between px-3 py-2 bg-slate-50 rounded-xl transition-colors hover:bg-slate-100';
              
              const info = document.createElement('div');
              info.className='flex-1';
              
              const name = document.createElement('div');
              name.className='text-sm font-medium truncate';
              name.textContent = e.name;
              
              if (e.note) {
                const note = document.createElement('div');
                note.className='text-xs text-slate-500 truncate';
                note.textContent = e.note;
                info.appendChild(name);
                info.appendChild(note);
              } else {
                info.appendChild(name);
              }
              
              const right = document.createElement('div');
              right.className='flex items-center gap-2 text-xs text-slate-500';
              
              if (e.createdAt && e.createdAt.toDate) {
                const time = e.createdAt.toDate();
                right.innerHTML = `<span>${time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
              }

              if (isAdmin){
                const delBtn = document.createElement('button');
                delBtn.title='Xóa đăng ký';
                delBtn.className='opacity-0 group-hover:opacity-100 px-2 py-1 rounded-lg bg-rose-500 text-white text-xs hover:bg-rose-600 transition-opacity';
                delBtn.innerHTML = '<i class="fas fa-times"></i>';
                delBtn.addEventListener('click', ()=>{
                  deleteShift(e.id);
                });
                right.appendChild(delBtn);
              }

              row.appendChild(info);
              row.appendChild(right);
              list.appendChild(row);
            });
          }

          wrap.appendChild(list);
          col.appendChild(wrap);
        });

        weekGrid.appendChild(col);
      }
    }

    function renderEmployeeDropdown() {
      empNameSelect.innerHTML = '<option value="">-- Chọn nhân viên --</option>';
      
      employees.forEach(employee => {
        const option = document.createElement('option');
        option.value = employee;
        option.textContent = employee;
        empNameSelect.appendChild(option);
      });
    }

    function renderEmployeeList() {
      employeeList.innerHTML = '';
      
      employees.forEach(employee => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-2 bg-slate-50 rounded-lg';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = employee;
        
        if (isAdmin) {
          const delBtn = document.createElement('button');
          delBtn.className = 'px-2 py-1 text-xs bg-rose-500 text-white rounded hover:bg-rose-600';
          delBtn.innerHTML = '<i class="fas fa-trash"></i>';
          delBtn.addEventListener('click', () => {
            deleteEmployee(employee);
          });
          
          li.appendChild(nameSpan);
          li.appendChild(delBtn);
        } else {
          li.appendChild(nameSpan);
        }
        
        employeeList.appendChild(li);
      });
    }

    function loadCapacityInputs() {
      capacityMorningInput.value = capacitySettings.morning || 2;
      capacityEveningWeekdayInput.value = capacitySettings.eveningWeekday || 4;
      capacityEveningWeekendInput.value = capacitySettings.eveningWeekend || 5;
      
      morningCapacityText.textContent = capacitySettings.morning || 2;
      eveningWeekdayCapacityText.textContent = capacitySettings.eveningWeekday || 4;
      eveningWeekendCapacityText.textContent = capacitySettings.eveningWeekend || 5;
    }

    function updateWeekInput(){
      weekStartInput.value = fmtISODate(currentWeekStart);
    }

    function checkAdmin(user) {
      // Đây là nơi bạn có thể kiểm tra xem user có phải là admin không
      // Có thể dựa vào email, custom claims, hoặc document trong Firestore
      // Ví dụ đơn giản: chỉ định một email làm admin
      const adminEmails = ['admin@company.com', 'minhtan@company.com'];
      return adminEmails.includes(user.email);
    }

    function setupEventListeners() {
      weekStartInput.addEventListener('change', (e)=>{
        const d = new Date(e.target.value);
        currentWeekStart = startOfWeek(d);
        updateWeekInput();
        renderDayChoices();
        loadWeekData();
      });

      prevWeekBtn.addEventListener('click', ()=>{
        currentWeekStart = addDays(currentWeekStart, -7);
        updateWeekInput();
        renderDayChoices();
        loadWeekData();
      });

      nextWeekBtn.addEventListener('click', ()=>{
        currentWeekStart = addDays(currentWeekStart, 7);
        updateWeekInput();
        renderDayChoices();
        loadWeekData();
      });

      signupForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = (empNameSelect.value||'').trim();
        if (!name){ showToast('Vui lòng chọn nhân viên.', 'err'); return; }
        const shift = shiftSelect.value;
        const dayIndex = parseInt(dayChoices.dataset.selected || '0');
        const note = (noteInput.value||'').trim();

        // Kiểm tra trùng
        const alreadyRegistered = weekData.some(e => 
          e.dayIndex === dayIndex && e.shift === shift && e.name === name
        );
        
        if (alreadyRegistered){
          showToast('Nhân viên đã đăng ký ca này rồi.', 'err');
          return;
        }

        // Kiểm tra còn slot
        const cap = capacityFor(dayIndex, shift);
        const current = weekData.filter(e => e.dayIndex === dayIndex && e.shift === shift);
        if (current.length >= cap){
          showToast('Ca đã đủ số lượng.', 'err');
          return;
        }

        addShift({ name, shift, dayIndex, note });
      });

      logoutBtn.addEventListener('click', () => {
        auth.signOut();
      });

      addEmployeeBtn.addEventListener('click', () => {
        const name = newEmployeeInput.value.trim();
        if (!name) {
          showToast('Vui lòng nhập tên nhân viên.', 'err');
          return;
        }
        
        if (employees.includes(name)) {
          showToast('Nhân viên đã tồn tại.', 'err');
          return;
        }
        
        addEmployee(name);
        newEmployeeInput.value = '';
      });

      saveCapacityBtn.addEventListener('click', () => {
        const morning = parseInt(capacityMorningInput.value) || 2;
        const eveningWeekday = parseInt(capacityEveningWeekdayInput.value) || 4;
        const eveningWeekend = parseInt(capacityEveningWeekendInput.value) || 5;
        
        if (morning < 1 || eveningWeekday < 1 || eveningWeekend < 1) {
          showToast('Sức chứa phải lớn hơn 0.', 'err');
          return;
        }
        
        capacitySettings = { morning, eveningWeekday, eveningWeekend };
        saveCapacitySettings();
        renderWeekGrid();
      });

      exportBtn.addEventListener('click', ()=>{
        if (!isAdmin) return;
        
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "LỊCH LÀM VIỆC - TUẦN BẮT ĐẦU " + fmtISODate(currentWeekStart) + "\r\n\r\n";
        csvContent += "Ngày,Buổi,Họ tên,Ghi chú,Giờ đăng ký\r\n";
        
        const data = weekData.slice().sort((a,b)=> a.dayIndex-b.dayIndex || a.shift.localeCompare(b.shift));
        
        data.forEach(entry=>{
          const dayDate = addDays(currentWeekStart, entry.dayIndex);
          const dateStr = `${dayDate.getDate()}/${dayDate.getMonth()+1}/${dayDate.getFullYear()}`;
          const shiftName = entry.shift === 'sang' ? 'Sáng' : 'Tối';
          let timeStr = '';
          
          if (entry.createdAt && entry.createdAt.toDate) {
            const time = entry.createdAt.toDate();
            timeStr = time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + ' ' + time.toLocaleDateString();
          }
          
          const escapeCSV = (str) => {
            if (!str) return '';
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          };
          
          csvContent += `${escapeCSV(dateStr)},${escapeCSV(shiftName)},${escapeCSV(entry.name)},${escapeCSV(entry.note)},${escapeCSV(timeStr)}\r\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `LichLamViec_${fmtISODate(currentWeekStart)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Đã xuất file Excel (CSV).', 'ok');
      });

      clearWeekBtn.addEventListener('click', ()=>{
        if (!isAdmin) return;
        if (!confirm('Xóa tất cả đăng ký trong tuần này? Không thể hoàn tác.')) return;
        clearWeek();
      });

      loginBtn.addEventListener('click', async () => {
        const email = loginEmail.value;
        const password = loginPassword.value;
        
        if (!email || !password) {
          showToast('Vui lòng nhập email và mật khẩu', 'err');
          return;
        }
        
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
          showToast('Email hoặc mật khẩu không đúng', 'err');
          console.error("Login error:", error);
        }
      });
    }

    // ====== Khởi tạo ứng dụng ======
    function initApp() {
      setupEventListeners();
      
      // Theo dõi trạng thái đăng nhập
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          userEmail.textContent = user.email;
          isAdmin = checkAdmin(user);
          
          // Ẩn màn hình đăng nhập, hiện ứng dụng
          loginScreen.classList.add('hidden');
          appContainer.classList.remove('hidden');
          
          // Hiện section admin nếu là admin
          if (isAdmin) {
            adminSection.classList.remove('hidden');
          } else {
            adminSection.classList.add('hidden');
          }
          
          // Tải dữ liệu
          await loadEmployees();
          await loadCapacitySettings();
          await loadWeekData();
          renderDayChoices();
          updateWeekInput();
          
        } else {
          // Hiện màn hình đăng nhập
          loginScreen.classList.remove('hidden');
          appContainer.classList.add('hidden');
          currentUser = null;
        }
      });
    }

    // Khởi chạy ứng dụng
    initApp();
  </script>
</body>
</html>